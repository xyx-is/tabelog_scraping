# coding: utf-8

require 'nokogiri'
require 'open-uri'
require 'csv'
require 'set'
require 'fileutils'
require 'parallel'
require 'date'

MAX_THREADS = 4

areas = [
#    add areas from areas.csv

"hokkaido/A0101/A010101",
"hokkaido/A0101/A010102",
"hokkaido/A0101/A010103",
"hokkaido/A0101/A010104",
"hokkaido/A0101/A010105",
"hokkaido/A0101/A010201",
"hokkaido/A0101/A010202",
"hokkaido/A0101/A010203",
"hokkaido/A0101/A010204",
"hokkaido/A0101/A010301",
"hokkaido/A0101/A010302",
"hokkaido/A0101/A010303",
"hokkaido/A0101/A010304",
"hokkaido/A0101/A010305",
"hokkaido/A0104/A010401",
"hokkaido/A0104/A010402",
"hokkaido/A0104/A010403",
"hokkaido/A0104/A010404",
"hokkaido/A0104/A010405",
"hokkaido/A0105/A010501",
"hokkaido/A0105/A010502",
"hokkaido/A0105/A010503",
"hokkaido/A0106/A010601",
"hokkaido/A0106/A010602",
"hokkaido/A0106/A010603",
"hokkaido/A0106/A010604",
"hokkaido/A0107/A010701",
"hokkaido/A0107/A010702",
"hokkaido/A0107/A010703",
"hokkaido/A0107/A010704",
"hokkaido/A0107/A010705",
"hokkaido/A0107/A010706",
"hokkaido/A0107/A010707",
"hokkaido/A0107/A010708",
"hokkaido/A0108/A010801",
"hokkaido/A0108/A010802",
"hokkaido/A0108/A010803",
"hokkaido/A0108/A010804",
"hokkaido/A0109/A010901",
"hokkaido/A0109/A010902",
"hokkaido/A0109/A010903",
"hokkaido/A0109/A010904",
"hokkaido/A0109/A010905",
"hokkaido/A0109/A010906",
"hokkaido/A0110/A011001",
"hokkaido/A0110/A011002",
"hokkaido/A0110/A011003",
"hokkaido/A0110/A011004",
"hokkaido/A0111/A011101",
"hokkaido/A0111/A011102",
"hokkaido/A0111/A011103",
"hokkaido/A0111/A011104",
"hokkaido/A0112/A011201",
"hokkaido/A0112/A011202",
"hokkaido/A0112/A011203",
"hokkaido/A0112/A011204",
"aomori/A0201/A020101",
"aomori/A0201/A020102",
"aomori/A0201/A020103",
"aomori/A0201/A020104",
"aomori/A0202/A020201",
"aomori/A0202/A020202",
"aomori/A0202/A020203",
"aomori/A0202/A020204",
"aomori/A0202/A020205",
"aomori/A0203/A020301",
"aomori/A0203/A020302",
"aomori/A0203/A020303",
"aomori/A0203/A020304",
"aomori/A0204/A020401",
"aomori/A0204/A020402",
"aomori/A0204/A020403",
"aomori/A0204/A020404",
"aomori/A0205/A020501",
"aomori/A0205/A020502",
"aomori/A0205/A020503",
"akita/A0501/A050101",
"akita/A0502/A050201",
"akita/A0502/A050202",
"akita/A0502/A050203",
"akita/A0503/A050301",
"akita/A0503/A050302",
"akita/A0503/A050303",
"akita/A0504/A050401",
"akita/A0504/A050402",
"akita/A0505/A050501",
"akita/A0505/A050502",
"akita/A0506/A050601",
"akita/A0506/A050602",
"yamagata/A0601/A060101",
"yamagata/A0601/A060102",
"yamagata/A0602/A060201",
"yamagata/A0602/A060202",
"yamagata/A0602/A060203",
"yamagata/A0602/A060204",
"yamagata/A0603/A060301",
"yamagata/A0603/A060302",
"yamagata/A0603/A060303",
"yamagata/A0604/A060401",
"yamagata/A0604/A060402",
"yamagata/A0604/A060403",
"yamagata/A0604/A060404",
"yamagata/A0605/A060501",
"yamagata/A0605/A060502",
"yamagata/A0605/A060503",
"yamagata/A0605/A060504",
"yamagata/A0605/A060505",
"iwate/A0301/A030101",
"iwate/A0301/A030102",
"iwate/A0301/A030103",
"iwate/A0301/A030104",
"iwate/A0302/A030201",
"iwate/A0302/A030202",
"iwate/A0302/A030203",
"iwate/A0302/A030204",
"iwate/A0302/A030205",
"iwate/A0303/A030301",
"iwate/A0303/A030302",
"iwate/A0303/A030303",
"iwate/A0303/A030304",
"iwate/A0304/A030401",
"iwate/A0304/A030402",
"iwate/A0304/A030403",
"iwate/A0304/A030404",
"iwate/A0304/A030405",
"iwate/A0304/A030406",
"iwate/A0305/A030501",
"iwate/A0305/A030502",
"iwate/A0305/A030503",
"miyagi/A0401/A040101",
"miyagi/A0401/A040102",
"miyagi/A0401/A040103",
"miyagi/A0401/A040104",
"miyagi/A0401/A040105",
"miyagi/A0402/A040201",
"miyagi/A0402/A040202",
"miyagi/A0402/A040203",
"miyagi/A0402/A040204",
"miyagi/A0403/A040301",
"miyagi/A0403/A040302",
"miyagi/A0403/A040303",
"miyagi/A0403/A040304",
"miyagi/A0404/A040401",
"miyagi/A0404/A040402",
"miyagi/A0404/A040403",
"miyagi/A0404/A040404",
"fukushima/A0701/A070101",
"fukushima/A0701/A070102",
"fukushima/A0701/A070103",
"fukushima/A0702/A070201",
"fukushima/A0702/A070202",
"fukushima/A0702/A070203",
"fukushima/A0703/A070301",
"fukushima/A0703/A070302",
"fukushima/A0703/A070303",
"fukushima/A0703/A070304",
"fukushima/A0704/A070401",
"fukushima/A0704/A070402",
"fukushima/A0704/A070403",
"fukushima/A0705/A070501",
"fukushima/A0705/A070502",
"fukushima/A0705/A070503",
"fukushima/A0706/A070601",
"fukushima/A0706/A070602",
"fukushima/A0707/A070701",
"fukushima/A0707/A070702",
"tokyo/A1301/A130101",
"tokyo/A1301/A130102",
"tokyo/A1301/A130103",
"tokyo/A1302/A130201",
"tokyo/A1302/A130202",
"tokyo/A1302/A130203",
"tokyo/A1302/A130204",
"tokyo/A1303/A130301",
"tokyo/A1303/A130302",
"tokyo/A1303/A130303",
"tokyo/A1304/A130401",
"tokyo/A1304/A130402",
"tokyo/A1304/A130403",
"tokyo/A1304/A130404",
"tokyo/A1305/A130501",
"tokyo/A1305/A130502",
"tokyo/A1305/A130503",
"tokyo/A1305/A130504",
"tokyo/A1306/A130601",
"tokyo/A1306/A130602",
"tokyo/A1306/A130603",
"tokyo/A1307/A130701",
"tokyo/A1307/A130702",
"tokyo/A1307/A130703",
"tokyo/A1307/A130704",
"tokyo/A1308/A130801",
"tokyo/A1308/A130802",
"tokyo/A1308/A130803",
"tokyo/A1309/A130901",
"tokyo/A1309/A130902",
"tokyo/A1309/A130903",
"tokyo/A1309/A130904",
"tokyo/A1309/A130905",
"tokyo/A1309/A130906",
"tokyo/A1310/A131001",
"tokyo/A1310/A131002",
"tokyo/A1310/A131003",
"tokyo/A1310/A131004",
"tokyo/A1311/A131101",
"tokyo/A1311/A131102",
"tokyo/A1311/A131103",
"tokyo/A1311/A131104",
"tokyo/A1311/A131105",
"tokyo/A1311/A131106",
"tokyo/A1312/A131201",
"tokyo/A1312/A131202",
"tokyo/A1312/A131203",
"tokyo/A1312/A131204",
"tokyo/A1312/A131205",
"tokyo/A1313/A131301",
"tokyo/A1313/A131302",
"tokyo/A1313/A131303",
"tokyo/A1313/A131304",
"tokyo/A1313/A131305",
"tokyo/A1313/A131306",
"tokyo/A1313/A131307",
"tokyo/A1314/A131401",
"tokyo/A1314/A131402",
"tokyo/A1314/A131403",
"tokyo/A1314/A131404",
"tokyo/A1314/A131405",
"tokyo/A1315/A131501",
"tokyo/A1315/A131502",
"tokyo/A1315/A131503",
"tokyo/A1315/A131504",
"tokyo/A1316/A131601",
"tokyo/A1316/A131602",
"tokyo/A1316/A131603",
"tokyo/A1316/A131604",
"tokyo/A1317/A131701",
"tokyo/A1317/A131702",
"tokyo/A1317/A131703",
"tokyo/A1317/A131704",
"tokyo/A1317/A131705",
"tokyo/A1317/A131706",
"tokyo/A1317/A131707",
"tokyo/A1317/A131708",
"tokyo/A1317/A131709",
"tokyo/A1317/A131710",
"tokyo/A1317/A131711",
"tokyo/A1317/A131712",
"tokyo/A1317/A131713",
"tokyo/A1317/A131714",
"tokyo/A1317/A131715",
"tokyo/A1317/A131716",
"tokyo/A1318/A131801",
"tokyo/A1318/A131802",
"tokyo/A1318/A131803",
"tokyo/A1318/A131804",
"tokyo/A1318/A131805",
"tokyo/A1318/A131806",
"tokyo/A1318/A131807",
"tokyo/A1318/A131808",
"tokyo/A1318/A131809",
"tokyo/A1318/A131810",
"tokyo/A1318/A131811",
"tokyo/A1318/A131812",
"tokyo/A1318/A131813",
"tokyo/A1318/A131814",
"tokyo/A1319/A131901",
"tokyo/A1319/A131902",
"tokyo/A1319/A131903",
"tokyo/A1319/A131904",
"tokyo/A1319/A131905",
"tokyo/A1319/A131906",
"tokyo/A1319/A131907",
"tokyo/A1320/A132001",
"tokyo/A1320/A132002",
"tokyo/A1320/A132003",
"tokyo/A1321/A132101",
"tokyo/A1321/A132102",
"tokyo/A1321/A132103",
"tokyo/A1321/A132104",
"tokyo/A1321/A132105",
"tokyo/A1322/A132201",
"tokyo/A1322/A132202",
"tokyo/A1322/A132203",
"tokyo/A1322/A132204",
"tokyo/A1322/A132205",
"tokyo/A1323/A132301",
"tokyo/A1323/A132302",
"tokyo/A1323/A132303",
"tokyo/A1323/A132304",
"tokyo/A1323/A132305",
"tokyo/A1324/A132401",
"tokyo/A1324/A132402",
"tokyo/A1324/A132403",
"tokyo/A1324/A132404",
"tokyo/A1325/A132501",
"tokyo/A1325/A132502",
"tokyo/A1325/A132503",
"tokyo/A1326/A132601",
"tokyo/A1326/A132602",
"tokyo/A1326/A132603",
"tokyo/A1327/A132701",
"tokyo/A1327/A132702",
"tokyo/A1327/A132703",
"tokyo/A1328/A132801",
"tokyo/A1328/A132802",
"tokyo/A1328/A132803",
"tokyo/A1328/A132804",
"tokyo/A1328/A132805",
"tokyo/A1328/A132806",
"tokyo/A1329/A132901",
"tokyo/A1329/A132902",
"tokyo/A1329/A132903",
"tokyo/A1329/A132904",
"tokyo/A1329/A132905",
"tokyo/A1330/A133001",
"tokyo/A1330/A133002",
"tokyo/A1330/A133003",
"tokyo/A1330/A133004",
"tokyo/A1331/A133101",
"tokyo/A1331/A133102",
"kanagawa/A1401/A140101",
"kanagawa/A1401/A140102",
"kanagawa/A1401/A140103",
"kanagawa/A1401/A140104",
"kanagawa/A1401/A140105",
"kanagawa/A1401/A140106",
"kanagawa/A1401/A140201",
"kanagawa/A1401/A140202",
"kanagawa/A1401/A140203",
"kanagawa/A1401/A140204",
"kanagawa/A1401/A140205",
"kanagawa/A1401/A140206",
"kanagawa/A1401/A140207",
"kanagawa/A1401/A140208",
"kanagawa/A1401/A140209",
"kanagawa/A1401/A140210",
"kanagawa/A1401/A140211",
"kanagawa/A1401/A140212",
"kanagawa/A1401/A140301",
"kanagawa/A1401/A140302",
"kanagawa/A1401/A140303",
"kanagawa/A1401/A140304",
"kanagawa/A1401/A140305",
"kanagawa/A1401/A140306",
"kanagawa/A1401/A140307",
"kanagawa/A1401/A140308",
"kanagawa/A1401/A140309",
"kanagawa/A1401/A140310",
"kanagawa/A1404/A140401",
"kanagawa/A1404/A140402",
"kanagawa/A1404/A140403",
"kanagawa/A1404/A140404",
"kanagawa/A1404/A140405",
"kanagawa/A1404/A140406",
"kanagawa/A1404/A140407",
"kanagawa/A1404/A140408",
"kanagawa/A1405/A140501",
"kanagawa/A1405/A140502",
"kanagawa/A1405/A140503",
"kanagawa/A1405/A140504",
"kanagawa/A1405/A140505",
"kanagawa/A1405/A140506",
"kanagawa/A1405/A140507",
"kanagawa/A1405/A140508",
"kanagawa/A1406/A140601",
"kanagawa/A1406/A140602",
"kanagawa/A1406/A140603",
"kanagawa/A1407/A140701",
"kanagawa/A1407/A140702",
"kanagawa/A1407/A140703",
"kanagawa/A1407/A140704",
"kanagawa/A1408/A140801",
"kanagawa/A1408/A140802",
"kanagawa/A1408/A140803",
"kanagawa/A1408/A140804",
"kanagawa/A1409/A140901",
"kanagawa/A1409/A140902",
"kanagawa/A1410/A141001",
"kanagawa/A1410/A141002",
"saitama/A1101/A110101",
"saitama/A1101/A110102",
"saitama/A1101/A110103",
"saitama/A1102/A110201",
"saitama/A1102/A110202",
"saitama/A1102/A110203",
"saitama/A1102/A110204",
"saitama/A1102/A110205",
"saitama/A1103/A110301",
"saitama/A1103/A110302",
"saitama/A1103/A110303",
"saitama/A1103/A110304",
"saitama/A1104/A110401",
"saitama/A1104/A110402",
"saitama/A1104/A110403",
"saitama/A1105/A110501",
"saitama/A1105/A110502",
"saitama/A1105/A110503",
"saitama/A1105/A110504",
"saitama/A1106/A110601",
"saitama/A1106/A110602",
"saitama/A1106/A110603",
"saitama/A1105/A110605",
"saitama/A1107/A110701",
"saitama/A1107/A110703",
"saitama/A1107/A110704",
"chiba/A1201/A120101",
"chiba/A1201/A120102",
"chiba/A1201/A120103",
"chiba/A1201/A120104",
"chiba/A1201/A120105",
"chiba/A1202/A120201",
"chiba/A1202/A120202",
"chiba/A1202/A120203",
"chiba/A1202/A120204",
"chiba/A1203/A120301",
"chiba/A1203/A120302",
"chiba/A1203/A120303",
"chiba/A1203/A120304",
"chiba/A1203/A120305",
"chiba/A1204/A120401",
"chiba/A1204/A120402",
"chiba/A1204/A120403",
"chiba/A1204/A120404",
"chiba/A1206/A120601",
"chiba/A1206/A120602",
"chiba/A1206/A120603",
"chiba/A1207/A120701",
"chiba/A1207/A120702",
"chiba/A1207/A120703",
"chiba/A1207/A120704",
"chiba/A1205/A120501",
"chiba/A1205/A120502",
"chiba/A1205/A120503",
"chiba/A1205/A120504",
"tochigi/A0901/A090101",
"tochigi/A0901/A090102",
"tochigi/A0902/A090201",
"tochigi/A0902/A090202",
"tochigi/A0902/A090203",
"tochigi/A0903/A090301",
"tochigi/A0903/A090302",
"tochigi/A0903/A090303",
"tochigi/A0903/A090304",
"tochigi/A0904/A090401",
"tochigi/A0904/A090402",
"tochigi/A0904/A090403",
"tochigi/A0905/A090501",
"tochigi/A0905/A090502",
"ibaraki/A0801/A080101",
"ibaraki/A0801/A080102",
"ibaraki/A0801/A080103",
"ibaraki/A0802/A080201",
"ibaraki/A0802/A080202",
"ibaraki/A0802/A080203",
"ibaraki/A0803/A080301",
"ibaraki/A0803/A080302",
"ibaraki/A0803/A080303",
"ibaraki/A0804/A080401",
"ibaraki/A0804/A080402",
"ibaraki/A0804/A080403",
"ibaraki/A0805/A080501",
"ibaraki/A0805/A080502",
"ibaraki/A0805/A080503",
"ibaraki/A0806/A080601",
"ibaraki/A0806/A080602",
"ibaraki/A0806/A080603",
"gunma/A1001/A100101",
"gunma/A1001/A100102",
"gunma/A1002/A100201",
"gunma/A1002/A100202",
"gunma/A1002/A100203",
"gunma/A1002/A100204",
"gunma/A1003/A100301",
"gunma/A1003/A100302",
"gunma/A1004/A100401",
"gunma/A1004/A100402",
"gunma/A1004/A100403",
"gunma/A1005/A100501",
"gunma/A1005/A100502",
"gunma/A1005/A100503",
"aichi/A2301/A230101",
"aichi/A2301/A230102",
"aichi/A2301/A230103",
"aichi/A2301/A230104",
"aichi/A2301/A230105",
"aichi/A2301/A230106",
"aichi/A2301/A230107",
"aichi/A2301/A230108",
"aichi/A2301/A230109",
"aichi/A2301/A230110",
"aichi/A2301/A230111",
"aichi/A2301/A230112",
"aichi/A2301/A230113",
"aichi/A2301/A230114",
"aichi/A2302/A230201",
"aichi/A2302/A230202",
"aichi/A2303/A230301",
"aichi/A2303/A230302",
"aichi/A2304/A230401",
"aichi/A2304/A230402",
"aichi/A2304/A230403",
"aichi/A2305/A230501",
"aichi/A2305/A230502",
"aichi/A2305/A230503",
"aichi/A2305/A230504",
"aichi/A2306/A230601",
"aichi/A2306/A230602",
"aichi/A2306/A230603",
"aichi/A2306/A230604",
"aichi/A2306/A230605",
"gifu/A2101/A210101",
"gifu/A2101/A210102",
"gifu/A2101/A210103",
"gifu/A2101/A210104",
"gifu/A2101/A210105",
"gifu/A2101/A210106",
"gifu/A2102/A210201",
"gifu/A2102/A210202",
"gifu/A2102/A210203",
"gifu/A2102/A210204",
"gifu/A2102/A210205",
"gifu/A2103/A210301",
"gifu/A2103/A210302",
"gifu/A2103/A210303",
"gifu/A2104/A210401",
"gifu/A2104/A210402",
"gifu/A2104/A210403",
"gifu/A2104/A210404",
"shizuoka/A2201/A220101",
"shizuoka/A2201/A220102",
"shizuoka/A2202/A220201",
"shizuoka/A2202/A220202",
"shizuoka/A2202/A220203",
"shizuoka/A2202/A220204",
"shizuoka/A2203/A220301",
"shizuoka/A2203/A220302",
"shizuoka/A2203/A220303",
"shizuoka/A2203/A220304",
"shizuoka/A2204/A220401",
"shizuoka/A2204/A220402",
"shizuoka/A2205/A220501",
"shizuoka/A2205/A220502",
"shizuoka/A2205/A220503",
"shizuoka/A2205/A220504",
"shizuoka/A2205/A220505",
"mie/A2401/A240101",
"mie/A2401/A240102",
"mie/A2401/A240103",
"mie/A2402/A240201",
"mie/A2402/A240202",
"mie/A2402/A240203",
"mie/A2403/A240301",
"mie/A2403/A240302",
"mie/A2403/A240303",
"mie/A2404/A240401",
"mie/A2404/A240402",
"mie/A2405/A240501",
"mie/A2405/A240502",
"niigata/A1501/A150101",
"niigata/A1501/A150102",
"niigata/A1501/A150103",
"niigata/A1502/A150201",
"niigata/A1502/A150202",
"niigata/A1503/A150301",
"niigata/A1503/A150302",
"niigata/A1503/A150303",
"niigata/A1504/A150401",
"niigata/A1504/A150402",
"niigata/A1504/A150403",
"niigata/A1504/A150404",
"niigata/A1505/A150501",
"niigata/A1505/A150502",
"niigata/A1505/A150503",
"niigata/A1505/A150504",
"niigata/A1505/A150505",
"yamanashi/A1901/A190101",
"yamanashi/A1901/A190102",
"yamanashi/A1901/A190103",
"yamanashi/A1901/A190104",
"yamanashi/A1902/A190201",
"yamanashi/A1902/A190202",
"yamanashi/A1902/A190203",
"yamanashi/A1902/A190204",
"yamanashi/A1903/A190301",
"yamanashi/A1903/A190302",
"yamanashi/A1903/A190303",
"yamanashi/A1904/A190401",
"yamanashi/A1904/A190402",
"yamanashi/A1905/A190501",
"yamanashi/A1905/A190502",
"yamanashi/A1905/A190503",
"nagano/A2001/A200101",
"nagano/A2001/A200102",
"nagano/A2001/A200103",
"nagano/A2001/A200104",
"nagano/A2001/A200105",
"nagano/A2001/A200106",
"nagano/A2002/A200201",
"nagano/A2002/A200202",
"nagano/A2002/A200203",
"nagano/A2002/A200204",
"nagano/A2003/A200301",
"nagano/A2003/A200302",
"nagano/A2003/A200303",
"nagano/A2004/A200401",
"nagano/A2004/A200402",
"nagano/A2004/A200403",
"nagano/A2004/A200404",
"nagano/A2004/A200405",
"nagano/A2005/A200501",
"nagano/A2005/A200502",
"nagano/A2005/A200503",
"nagano/A2006/A200601",
"nagano/A2006/A200602",
"nagano/A2006/A200603",
"nagano/A2006/A200604",
"nagano/A2007/A200701",
"nagano/A2007/A200702",
"ishikawa/A1701/A170101",
"ishikawa/A1701/A170102",
"ishikawa/A1702/A170201",
"ishikawa/A1702/A170202",
"ishikawa/A1702/A170203",
"ishikawa/A1703/A170301",
"ishikawa/A1703/A170302",
"ishikawa/A1703/A170303",
"ishikawa/A1704/A170401",
"ishikawa/A1704/A170402",
"ishikawa/A1704/A170403",
"ishikawa/A1704/A170404",
"toyama/A1601/A160101",
"toyama/A1601/A160102",
"toyama/A1602/A160201",
"toyama/A1602/A160202",
"toyama/A1602/A160203",
"toyama/A1603/A160301",
"toyama/A1604/A160401",
"toyama/A1604/A160402",
"toyama/A1604/A160403",
"toyama/A1605/A160501",
"toyama/A1605/A160502",
"fukui/A1801/A180101",
"fukui/A1801/A180102",
"fukui/A1801/A180103",
"fukui/A1802/A180201",
"fukui/A1802/A180202",
"fukui/A1803/A180301",
"fukui/A1803/A180302",
"fukui/A1803/A180303",
"fukui/A1803/A180304",
"fukui/A1804/A180401",
"fukui/A1804/A180402",
"osaka/A2701/A270101",
"osaka/A2701/A270102",
"osaka/A2701/A270103",
"osaka/A2701/A270104",
"osaka/A2701/A270105",
"osaka/A2701/A270106",
"osaka/A2701/A270107",
"osaka/A2701/A270108",
"osaka/A2701/A270201",
"osaka/A2701/A270202",
"osaka/A2701/A270203",
"osaka/A2701/A270204",
"osaka/A2701/A270205",
"osaka/A2701/A270206",
"osaka/A2701/A270301",
"osaka/A2701/A270302",
"osaka/A2701/A270304",
"osaka/A2701/A270305",
"osaka/A2701/A270306",
"osaka/A2701/A270307",
"osaka/A2701/A270401",
"osaka/A2701/A270402",
"osaka/A2701/A270403",
"osaka/A2701/A270404",
"osaka/A2701/A270405",
"osaka/A2701/A270406",
"osaka/A2701/A270407",
"osaka/A2705/A270501",
"osaka/A2705/A270502",
"osaka/A2705/A270503",
"osaka/A2705/A270504",
"osaka/A2706/A270601",
"osaka/A2706/A270602",
"osaka/A2706/A270603",
"osaka/A2706/A270604",
"osaka/A2706/A270605",
"osaka/A2707/A270701",
"osaka/A2707/A270702",
"osaka/A2707/A270703",
"osaka/A2707/A270704",
"osaka/A2707/A270705",
"osaka/A2708/A270801",
"osaka/A2708/A270802",
"osaka/A2708/A270803",
"hyogo/A2801/A280101",
"hyogo/A2801/A280102",
"hyogo/A2801/A280103",
"hyogo/A2801/A280104",
"hyogo/A2801/A280105",
"hyogo/A2801/A280106",
"hyogo/A2801/A280107",
"hyogo/A2801/A280108",
"hyogo/A2801/A280109",
"hyogo/A2801/A280110",
"hyogo/A2801/A280111",
"hyogo/A2801/A280112",
"hyogo/A2803/A280301",
"hyogo/A2803/A280302",
"hyogo/A2803/A280303",
"hyogo/A2803/A280304",
"hyogo/A2803/A280305",
"hyogo/A2803/A280306",
"hyogo/A2804/A280401",
"hyogo/A2804/A280402",
"hyogo/A2804/A280403",
"hyogo/A2804/A280404",
"hyogo/A2805/A280501",
"hyogo/A2805/A280502",
"hyogo/A2805/A280503",
"hyogo/A2805/A280504",
"hyogo/A2805/A280505",
"hyogo/A2805/A280506",
"hyogo/A2806/A280601",
"hyogo/A2806/A280602",
"hyogo/A2806/A280603",
"hyogo/A2807/A280701",
"hyogo/A2807/A280702",
"hyogo/A2807/A280703",
"hyogo/A2808/A280801",
"hyogo/A2808/A280802",
"hyogo/A2808/A280803",
"kyoto/A2601/A260101",
"kyoto/A2601/A260201",
"kyoto/A2601/A260202",
"kyoto/A2601/A260203",
"kyoto/A2601/A260301",
"kyoto/A2601/A260302",
"kyoto/A2601/A260303",
"kyoto/A2601/A260304",
"kyoto/A2601/A260401",
"kyoto/A2601/A260402",
"kyoto/A2601/A260403",
"kyoto/A2601/A260404",
"kyoto/A2601/A260501",
"kyoto/A2601/A260502",
"kyoto/A2601/A260503",
"kyoto/A2601/A260504",
"kyoto/A2601/A260601",
"kyoto/A2601/A260604",
"kyoto/A2601/A260603",
"kyoto/A2601/A260602",
"kyoto/A2601/A260605",
"kyoto/A2607/A260701",
"kyoto/A2607/A260702",
"kyoto/A2607/A260703",
"kyoto/A2607/A260704",
"kyoto/A2607/A260705",
"kyoto/A2608/A260801",
"kyoto/A2608/A260802",
"kyoto/A2608/A260803",
"kyoto/A2609/A260901",
"kyoto/A2609/A260902",
"kyoto/A2609/A260903",
"shiga/A2501/A250101",
"shiga/A2502/A250201",
"shiga/A2502/A250202",
"shiga/A2502/A250203",
"shiga/A2503/A250301",
"shiga/A2503/A250302",
"shiga/A2503/A250303",
"shiga/A2504/A250401",
"shiga/A2504/A250402",
"shiga/A2504/A250403",
"shiga/A2505/A250501",
"nara/A2901/A290101",
"nara/A2901/A290102",
"nara/A2902/A290201",
"nara/A2902/A290202",
"nara/A2902/A290203",
"nara/A2903/A290301",
"nara/A2903/A290302",
"nara/A2903/A290303",
"nara/A2904/A290401",
"nara/A2904/A290402",
"nara/A2904/A290403",
"nara/A2905/A290501",
"nara/A2905/A290502",
"nara/A2905/A290503",
"wakayama/A3001/A300101",
"wakayama/A3001/A300102",
"wakayama/A3001/A300103",
"wakayama/A3002/A300201",
"wakayama/A3002/A300202",
"wakayama/A3002/A300203",
"wakayama/A3003/A300301",
"wakayama/A3003/A300302",
"wakayama/A3003/A300303",
"wakayama/A3004/A300401",
"wakayama/A3004/A300402",
"wakayama/A3004/A300403",
"wakayama/A3005/A300501",
"wakayama/A3005/A300502",
"wakayama/A3005/A300503",
"wakayama/A3005/A300504",
"okayama/A3301/A330101",
"okayama/A3301/A330102",
"okayama/A3301/A330103",
"okayama/A3301/A330104",
"okayama/A3302/A330201",
"okayama/A3302/A330202",
"okayama/A3302/A330203",
"okayama/A3302/A330204",
"okayama/A3302/A330205",
"okayama/A3302/A330206",
"okayama/A3303/A330301",
"okayama/A3303/A330302",
"okayama/A3304/A330401",
"okayama/A3304/A330402",
"okayama/A3305/A330501",
"okayama/A3305/A330502",
"hiroshima/A3401/A340121",
"hiroshima/A3401/A340108",
"hiroshima/A3401/A340109",
"hiroshima/A3401/A340110",
"hiroshima/A3401/A340111",
"hiroshima/A3401/A340112",
"hiroshima/A3401/A340113",
"hiroshima/A3401/A340114",
"hiroshima/A3401/A340115",
"hiroshima/A3401/A340116",
"hiroshima/A3401/A340117",
"hiroshima/A3401/A340118",
"hiroshima/A3401/A340119",
"hiroshima/A3401/A340120",
"hiroshima/A3401/A340101",
"hiroshima/A3401/A340104",
"hiroshima/A3401/A340103",
"hiroshima/A3401/A340122",
"hiroshima/A3401/A340102",
"hiroshima/A3401/A340123",
"hiroshima/A3401/A340126",
"hiroshima/A3401/A340127",
"hiroshima/A3401/A340105",
"hiroshima/A3401/A340404",
"hiroshima/A3401/A340124",
"hiroshima/A3401/A340125",
"hiroshima/A3401/A340107",
"hiroshima/A3401/A340106",
"hiroshima/A3403/A340301",
"hiroshima/A3403/A340304",
"hiroshima/A3403/A340305",
"hiroshima/A3403/A340306",
"hiroshima/A3403/A340307",
"hiroshima/A3403/A340308",
"hiroshima/A3406/A340302",
"hiroshima/A3406/A340602",
"hiroshima/A3406/A340601",
"hiroshima/A3406/A340603",
"hiroshima/A3407/A340701",
"hiroshima/A3407/A340403",
"hiroshima/A3407/A340702",
"hiroshima/A3404/A340401",
"hiroshima/A3404/A340402",
"hiroshima/A3404/A340303",
"hiroshima/A3404/A340405",
"hiroshima/A3404/A340406",
"hiroshima/A3402/A340202",
"hiroshima/A3402/A340205",
"hiroshima/A3402/A340201",
"hiroshima/A3402/A340203",
"hiroshima/A3405/A340501",
"hiroshima/A3405/A340502",
"hiroshima/A3405/A340503",
"hiroshima/A3405/A340504",
"hiroshima/A3408/A340204",
"hiroshima/A3408/A340801",
"tottori/A3101/A310101",
"tottori/A3101/A310102",
"tottori/A3102/A310201",
"tottori/A3102/A310202",
"tottori/A3102/A310203",
"tottori/A3103/A310301",
"tottori/A3103/A310302",
"tottori/A3103/A310303",
"tottori/A3103/A310304",
"shimane/A3201/A320101",
"shimane/A3201/A320102",
"shimane/A3202/A320201",
"shimane/A3202/A320203",
"shimane/A3202/A320204",
"shimane/A3203/A320301",
"shimane/A3203/A320302",
"shimane/A3203/A320303",
"shimane/A3203/A320304",
"shimane/A3204/A320401",
"shimane/A3204/A320402",
"shimane/A3205/A320501",
"yamaguchi/A3501/A350101",
"yamaguchi/A3501/A350102",
"yamaguchi/A3502/A350201",
"yamaguchi/A3503/A350301",
"yamaguchi/A3503/A350302",
"yamaguchi/A3503/A350303",
"yamaguchi/A3503/A350304",
"yamaguchi/A3504/A350401",
"yamaguchi/A3504/A350402",
"yamaguchi/A3505/A350501",
"yamaguchi/A3505/A350502",
"yamaguchi/A3506/A350601",
"yamaguchi/A3506/A350602",
"yamaguchi/A3506/A350603",
"kagawa/A3701/A370101",
"kagawa/A3701/A370102",
"kagawa/A3701/A370103",
"kagawa/A3702/A370201",
"kagawa/A3702/A370202",
"kagawa/A3702/A370203",
"kagawa/A3703/A370301",
"kagawa/A3703/A370302",
"kagawa/A3703/A370303",
"kagawa/A3704/A370401",
"kagawa/A3704/A370402",
"kagawa/A3705/A370501",
"tokushima/A3601/A360101",
"tokushima/A3601/A360102",
"tokushima/A3601/A360103",
"tokushima/A3601/A360104",
"tokushima/A3602/A360201",
"tokushima/A3602/A360202",
"tokushima/A3602/A360203",
"tokushima/A3602/A360204",
"tokushima/A3603/A360301",
"tokushima/A3603/A360302",
"tokushima/A3603/A360303",
"tokushima/A3604/A360401",
"tokushima/A3604/A360402",
"ehime/A3801/A380101",
"ehime/A3801/A380102",
"ehime/A3801/A380103",
"ehime/A3802/A380201",
"ehime/A3802/A380202",
"ehime/A3802/A380203",
"ehime/A3802/A380204",
"ehime/A3802/A380205",
"ehime/A3803/A380301",
"ehime/A3803/A380302",
"ehime/A3803/A380303",
"ehime/A3803/A380304",
"ehime/A3804/A380401",
"ehime/A3804/A380402",
"ehime/A3804/A380403",
"ehime/A3804/A380404",
"kochi/A3901/A390101",
"kochi/A3901/A390102",
"kochi/A3901/A390103",
"kochi/A3901/A390104",
"kochi/A3901/A390105",
"kochi/A3901/A390106",
"kochi/A3902/A390201",
"kochi/A3902/A390202",
"kochi/A3902/A390203",
"kochi/A3903/A390301",
"kochi/A3903/A390302",
"kochi/A3903/A390303",
"kochi/A3904/A390401",
"kochi/A3904/A390402",
"kochi/A3904/A390403",
"kochi/A3904/A390404",
"fukuoka/A4001/A400101",
"fukuoka/A4001/A400102",
"fukuoka/A4001/A400103",
"fukuoka/A4001/A400104",
"fukuoka/A4001/A400105",
"fukuoka/A4001/A400106",
"fukuoka/A4001/A400107",
"fukuoka/A4001/A400108",
"fukuoka/A4001/A400201",
"fukuoka/A4001/A400202",
"fukuoka/A4001/A400203",
"fukuoka/A4003/A400301",
"fukuoka/A4003/A400302",
"fukuoka/A4003/A400303",
"fukuoka/A4004/A400401",
"fukuoka/A4004/A400402",
"fukuoka/A4004/A400403",
"fukuoka/A4004/A400404",
"fukuoka/A4004/A400501",
"fukuoka/A4004/A400502",
"fukuoka/A4004/A400503",
"fukuoka/A4006/A400601",
"fukuoka/A4006/A400602",
"fukuoka/A4006/A400603",
"fukuoka/A4007/A400701",
"fukuoka/A4007/A400702",
"fukuoka/A4007/A400703",
"fukuoka/A4008/A400801",
"fukuoka/A4008/A400802",
"fukuoka/A4008/A400803",
"fukuoka/A4008/A400804",
"fukuoka/A4008/A400805",
"fukuoka/A4008/A400806",
"fukuoka/A4008/A400807",
"fukuoka/A4009/A400901",
"saga/A4101/A410101",
"saga/A4101/A410102",
"saga/A4101/A410103",
"saga/A4102/A410201",
"saga/A4102/A410202",
"saga/A4103/A410301",
"saga/A4103/A410302",
"saga/A4103/A410303",
"saga/A4104/A410401",
"saga/A4104/A410402",
"saga/A4104/A410403",
"nagasaki/A4201/A420101",
"nagasaki/A4201/A420102",
"nagasaki/A4201/A420103",
"nagasaki/A4202/A420201",
"nagasaki/A4202/A420202",
"nagasaki/A4202/A420203",
"nagasaki/A4203/A420301",
"nagasaki/A4203/A420302",
"nagasaki/A4203/A420303",
"nagasaki/A4204/A420401",
"nagasaki/A4204/A420402",
"nagasaki/A4205/A420501",
"nagasaki/A4205/A420502",
"nagasaki/A4205/A420503",
"kumamoto/A4301/A430101",
"kumamoto/A4301/A430102",
"kumamoto/A4301/A430103",
"kumamoto/A4301/A430104",
"kumamoto/A4301/A430105",
"kumamoto/A4302/A430201",
"kumamoto/A4302/A430202",
"kumamoto/A4302/A430203",
"kumamoto/A4303/A430301",
"kumamoto/A4303/A430302",
"kumamoto/A4304/A430401",
"kumamoto/A4304/A430402",
"kumamoto/A4304/A430403",
"kumamoto/A4304/A430404",
"kumamoto/A4305/A430501",
"oita/A4401/A440101",
"oita/A4401/A440102",
"oita/A4401/A440103",
"oita/A4401/A440104",
"oita/A4401/A440105",
"oita/A4402/A440201",
"oita/A4402/A440202",
"oita/A4403/A440301",
"oita/A4403/A440302",
"oita/A4404/A440401",
"oita/A4404/A440402",
"oita/A4404/A440403",
"oita/A4404/A440404",
"miyazaki/A4501/A450101",
"miyazaki/A4501/A450102",
"miyazaki/A4502/A450201",
"miyazaki/A4502/A450202",
"miyazaki/A4503/A450301",
"miyazaki/A4503/A450302",
"miyazaki/A4503/A450303",
"miyazaki/A4503/A450304",
"miyazaki/A4504/A450401",
"miyazaki/A4504/A450402",
"miyazaki/A4504/A450403",
"miyazaki/A4504/A450404",
"miyazaki/A4504/A450405",
"miyazaki/A4505/A450501",
"miyazaki/A4505/A450502",
"kagoshima/A4601/A460101",
"kagoshima/A4601/A460102",
"kagoshima/A4601/A460103",
"kagoshima/A4601/A460104",
"kagoshima/A4601/A460105",
"kagoshima/A4602/A460201",
"kagoshima/A4602/A460202",
"kagoshima/A4602/A460203",
"kagoshima/A4602/A460204",
"kagoshima/A4603/A460301",
"kagoshima/A4603/A460302",
"kagoshima/A4603/A460303",
"kagoshima/A4604/A460401",
"kagoshima/A4604/A460402",
"kagoshima/A4604/A460403",
"kagoshima/A4605/A460501",
"kagoshima/A4605/A460502",
"kagoshima/A4605/A460503",
"okinawa/A4701/A470101",
"okinawa/A4701/A470102",
"okinawa/A4701/A470103",
"okinawa/A4702/A470201",
"okinawa/A4702/A470202",
"okinawa/A4702/A470203",
"okinawa/A4702/A470204",
"okinawa/A4702/A470205",
"okinawa/A4703/A470301",
"okinawa/A4703/A470302",
"okinawa/A4703/A470303",
"okinawa/A4703/A470304",
"okinawa/A4704/A470401",
"okinawa/A4704/A470402",
"okinawa/A4704/A470403",
"okinawa/A4703/A470404",
"okinawa/A4704/A470405",
"okinawa/A4705/A470501",
"okinawa/A4705/A470502",
"okinawa/A4705/A470503",
"okinawa/A4705/A470504",
"okinawa/A4705/A470505",
"okinawa/A4706/A470601",
"okinawa/A4706/A470602",
]

GENRE_TREES = [
  {key: "RC", subgenres: [
    {key: "washoku", subgenres: [
      {key: "japanese", subgenres: [
        {key: "RC010101",},
        {key: "RC010103",},
        {key: "RC010105",},
        {key: "RC010104",},
      ]},
      {key: "sushi", subgenres: [
        {key: "RC010201",},
        {key: "RC010202",},
        {key: "RC010203",},
      ]},
      {key: "seafood", subgenres: [
        {key: "RC011211",},
        {key: "RC011212",},
        {key: "RC011213",},
        {key: "RC011214",},
        {key: "RC011215",},
      ]},
      {key: "RC0103", subgenres: [
        {key: "tempura",},
        {key: "tonkatsu",},
        {key: "kushiage",},
        {key: "RC010304",},
        {key: "RC010399",},
      ]},
      {key: "RC0104", subgenres: [
        {key: "soba",},
        {key: "RC010408",},
        {key: "udon",},
        {key: "RC010407",},
        {key: "RC010406",},
        {key: "RC010404",},
        {key: "RC010403",},
        {key: "RC010405",},
        {key: "RC010499",},
      ]},
      {key: "RC0105", subgenres: [
        {key: "unagi",},
        {key: "RC010502",},
        {key: "RC010503",},
      ]},
      {key: "RC0106", subgenres: [
        {key: "yakitori",},
        {key: "RC010602",},
        {key: "RC010604",},
        {key: "RC010605",},
        {key: "RC010603",},
        {key: "RC010606",},
      ]},
      {key: "RC0107", subgenres: [
        {key: "RC010701",},
        {key: "syabusyabu",},
        {key: "RC010703",},
      ]},
      {key: "RC0108",},
      {key: "RC0109", subgenres: [
        {key: "okonomiyaki",},
        {key: "monjya",},
        {key: "RC010911",},
        {key: "RC010912",},
        {key: "RC010999",},
      ]},
      {key: "RC0110", subgenres: [
        {key: "okinawafood",},
        {key: "RC011002",},
        {key: "RC011099",},
      ]},
      {key: "RC0111", subgenres: [
        {key: "RC011101",},
        {key: "RC011102",},
        {key: "RC011103",},
        {key: "RC011104",},
        {key: "RC011105",},
        {key: "RC011106",},
        {key: "RC011199",},
      ]},
      {key: "RC0199", subgenres: [
        {key: "RC019910",},
        {key: "RC019908",},
        {key: "RC019909",},
        {key: "RC019912",},
        {key: "RC019911",},
        {key: "RC019907",},
        {key: "RC019903",},
        {key: "RC019999",},
      ]},
    ]},
    {key: "RC02", subgenres: [
      {key: "RC0201", subgenres: [
        {key: "steak",},
        {key: "hamburgersteak",},
      ]},
      {key: "RC0203",},
      {key: "RC0202", subgenres: [
        {key: "pasta",},
        {key: "pizza",},
      ]},
      {key: "hamburger",},
      {key: "RC0209", subgenres: [
        {key: "yoshoku",},
        {key: "RC020911",},
        {key: "RC020912",},
        {key: "RC020913",},
        {key: "RC020914",},
        {key: "RC020915",},
        {key: "RC020999",},
      ]},
      {key: "french", subgenres: [
        {key: "RC021101",},
        {key: "RC021102",},
        {key: "RC021103",},
      ]},
      {key: "italian",},
      {key: "spain", subgenres: [
        {key: "RC021301",},
        {key: "RC021302",},
      ]},
      {key: "RC0219", subgenres: [
        {key: "RC021902",},
        {key: "RC021903",},
        {key: "RC021904",},
        {key: "RC021905",},
        {key: "RC021906",},
        {key: "RC021907",},
        {key: "RC021908",},
        {key: "RC021999",},
      ]},
    ]},
    {key: "chinese", subgenres: [
      {key: "RC0301", subgenres: [
        {key: "RC030101",},
        {key: "RC030102",},
        {key: "RC030103",},
        {key: "RC030104",},
        {key: "RC030105",},
        {key: "RC030106",},
        {key: "RC030107",},
      ]},
      {key: "RC0302", subgenres: [
        {key: "gyouza",},
        {key: "RC030202",},
      ]},
      {key: "RC0303",},
      {key: "RC0304", subgenres: [
        {key: "RC030401",},
        {key: "RC030402",},
        {key: "RC030403",},
      ]},
    ]},
    {key: "RC04", subgenres: [
      {key: "korea", subgenres: [
        {key: "RC040101",},
        {key: "RC040102",},
      ]},
      {key: "RC0402", subgenres: [
        {key: "thai",},
        {key: "RC040202",},
        {key: "RC040203",},
        {key: "RC040204",},
        {key: "RC040299",},
      ]},
      {key: "RC0403", subgenres: [
        {key: "RC040301",},
        {key: "RC040302",},
        {key: "RC040303",},
        {key: "RC040304",},
        {key: "RC040399",},
      ]},
      {key: "RC0404", subgenres: [
        {key: "RC040401",},
        {key: "RC040499",},
      ]},
      {key: "RC0411", subgenres: [
        {key: "RC041101",},
        {key: "RC041102",},
        {key: "RC041199",},
      ]},
      {key: "RC0412",},
      {key: "RC0499",},
    ]},
    {key: "curry", subgenres: [
      {key: "RC1201",},
      {key: "RC1202",},
      {key: "RC1203",},
      {key: "RC1204",},
      {key: "RC1205",},
      {key: "RC1299",},
    ]},
    {key: "RC13", subgenres: [
      {key: "RC1301", subgenres: [
        {key: "yakiniku",},
        {key: "horumon",},
      ]},
      {key: "RC1302",},
    ]},
    {key: "nabe", subgenres: [
      {key: "RC1401",},
      {key: "RC1402",},
      {key: "motsu",},
      {key: "RC1404",},
      {key: "RC1405",},
      {key: "RC1406",},
      {key: "RC1407",},
      {key: "RC1409",},
      {key: "RC1408",},
    ]},
    {key: "RC21", subgenres: [
      {key: "izakaya",},
      {key: "RC2102",},
      {key: "RC2199", subgenres: [
        {key: "RC219902",},
        {key: "RC219903",},
        {key: "RC219904",},
        {key: "RC219999",},
      ]},
    ]},
    {key: "RC22", subgenres: [
      {key: "RC2201",},
      {key: "RC2202",},
      {key: "RC2203",},
    ]},
    {key: "RC23",},
    {key: "RC99", subgenres: [
      {key: "RC9901", subgenres: [
        {key: "RC990101",},
        {key: "RC990102",},
        {key: "RC990103",},
      ]},
      {key: "RC9903", subgenres: [
        {key: "RC990301",},
        {key: "RC990302",},
      ]},
      {key: "RC9904", subgenres: [
        {key: "RC990401",},
        {key: "RC990402",},
      ]},
      {key: "RC9999", subgenres: [
        {key: "viking",},
        {key: "RC999903",},
        {key: "RC999901",},
        {key: "RC999913",},
        {key: "RC999902",},
        {key: "RC999905",},
        {key: "RC999907",},
        {key: "RC999908",},
        {key: "RC999909",},
        {key: "RC999910",},
        {key: "RC999911",},
        {key: "RC999912",},
        {key: "RC999914",},
        {key: "RC999999",},
      ]},
    ]},
  ]},
  {key: "MC", subgenres: [
    {key: "ramen",},
    {key: "MC21", subgenres: [
      {key: "MC2101",},
      {key: "MC2102",},
      {key: "MC2103",},
    ]},
    {key: "MC11",},
  ]},
  {key: "cafe", subgenres: [
    {key: "CC01",},
    {key: "CC02",},
    {key: "CC03",},
    {key: "CC04",},
    {key: "CC05",},
    {key: "CC06",},
    {key: "CC99",},
  ]},
  {key: "SC", subgenres: [
    {key: "pan", subgenres: [
      {key: "SC0101",},
      {key: "SC0102",},
      {key: "SC0103",},
      {key: "SC0199",},
    ]},
    {key: "sweets", subgenres: [
      {key: "SC0201", subgenres: [
        {key: "cake",},
        {key: "SC020102",},
        {key: "SC020103",},
        {key: "SC020104",},
        {key: "SC020199",},
      ]},
      {key: "SC0202", subgenres: [
        {key: "SC020201",},
        {key: "SC020202",},
        {key: "SC020203",},
        {key: "SC020204",},
        {key: "SC020205",},
        {key: "SC020206",},
      ]},
      {key: "SC0203",},
      {key: "SC0299", subgenres: [
        {key: "SC029901",},
        {key: "SC029909",},
        {key: "SC029907",},
        {key: "SC029903",},
        {key: "SC029904",},
        {key: "SC029902",},
        {key: "SC029905",},
        {key: "SC029906",},
        {key: "SC029908",},
        {key: "SC029910",},
        {key: "SC029911",},
        {key: "SC029999",},
      ]},
    ]},
  ]},
  {key: "bar", subgenres: [
    {key: "BC01",},
    {key: "BC02",},
    {key: "BC03",},
    {key: "BC04",},
    {key: "BC05",},
    {key: "BC06",},
    {key: "BC07",},
    {key: "BC99", subgenres: [
      {key: "BC9901", subgenres: [
        {key: "BC990101",},
        {key: "BC990102",},
      ]},
      {key: "BC9999",},
    ]},
  ]},
  {key: "YC", subgenres: [
    {key: "ryokan",},
    {key: "YC02",},
    {key: "YC99",},
  ]},
  {key: "ZZ",},
]



# define try of Rails
class Object
  alias try send
end

class NilClass
  def try(*args)
    nil
  end
end


SEARCH_RESULT_PROCESS = lambda do |doc|
  entries = doc.css("li.list-rst")
  {
    list_count: doc.css(".list-condition__count").text.strip.to_i,
    restaurants: entries.map{|entry|
      area, genre = entry.css("span.list-rst__area-genre")[0].text.strip.split("/")
      {
        url: entry.attribute("data-detail-url").value,
        id: entry.attribute("data-rst-id").value,
        name: entry.css("a.list-rst__rst-name-target")[0].text.strip,
        area: area,
        genre: genre,
        has_pr: entry.css("div.list-rst__pr").any?,
        rating: entry.css("span.list-rst__rating-val")[0].try(:text).try(:strip),
        review_count: entry.css(".list-rst__rvw-count-num")[0].text.strip.to_i,
        dinner_budget: entry.css("span.cpy-dinner-budget-val")[0].text.strip,
        lunch_budget: entry.css("span.cpy-lunch-budget-val")[0].text.strip,
        has_holiday_notice: entry.css(".list-rst__holiday-notice").any?,
        search_words: entry.css("ul.list-rst__search-word li.list-rst__search-word-item").map(&:text).map(&:strip),
        img_count: entry.css(".list-rst__rst-photo")[0].attribute("data-photo-set").value.split(",").select{|id_str| id_str.length>0}.length,
        has_calendar: entry.css(".list-rst__calendar").any?,
      }
    },
  }
end



def read_data_from_url(url, process)
  doc = Nokogiri::HTML.parse(open(url), url)
  process[doc]
end

ORDER_TYPES = {
  raking: "?Srt=D&SrtT=rt&sort_mode=1",
  standard: "",
  new_open: "?Srt=D&SrtT=nod",
}

def create_search_url(area, genre, page, order_type)
  genre_str = genre ? "#{genre}/" : ""
  page_str = page ? "#{page}/" : ""
  order_type_str = ORDER_TYPES[order_type]

  "https://tabelog.com/#{area}/rstLst/#{genre_str}#{page_str}#{order_type_str}"
end

MAX_PAGE = 60
ENTRY_PER_PAGE = 20

def process_area_genre(area, genre, subgenre_trees, output_restaurant_lines_proc, no_subgenre_proc)
  search_data = read_data_from_url(create_search_url(area, genre, 1, :raking), SEARCH_RESULT_PROCESS)
  output_restaurant_lines_proc[search_data[:restaurants]]
  list_count = search_data[:list_count]

  if list_count > ENTRY_PER_PAGE*MAX_PAGE then
    # subgenre_trees is nil or Array
    if subgenre_trees then
      # if there are over 1200 search results and subgenres, use subgenres
      subgenre_trees.each do |subgenre_tree|
        process_area_genre(area, subgenre_tree[:key], subgenre_tree[:subgenres], output_restaurant_lines_proc, no_subgenre_proc)
      end
    else
      # no subgenre
      for page in (2...MAX_PAGE) do
        search_data = read_data_from_url(create_search_url(area, genre, page, :raking), SEARCH_RESULT_PROCESS)
        output_restaurant_lines_proc[search_data[:restaurants]]
      end

      last_url = create_search_url(area, genre, MAX_PAGE, :raking)
      search_data = read_data_from_url(last_url, SEARCH_RESULT_PROCESS)
      output_restaurant_lines_proc[search_data[:restaurants]]
      min_rating = search_data[:restaurants].last[:rating]
      no_subgenre_proc[area, genre, last_url, min_rating]

      [:standard, :new_open].each do |order_type|
        for page in (1..MAX_PAGE) do
          search_data = read_data_from_url(create_search_url(area, genre, page, :raking), SEARCH_RESULT_PROCESS)
          output_restaurant_lines_proc[search_data[:restaurants]]
        end
      end
    end
  else
    for page in (2..MAX_PAGE) do
      search_data = read_data_from_url(create_search_url(area, genre, page, :raking), SEARCH_RESULT_PROCESS)
      output_restaurant_lines_proc[search_data[:restaurants]]
      if search_data[:restaurants].length < ENTRY_PER_PAGE then
        break
      end
    end
  end
end

def restaurant_line_data_to_array(area, restaurant_line_data)
  ([area] +
    [:url, :id, :name, :area, :genre, :has_pr, :rating, :review_count, :dinner_budget, :lunch_budget, :has_holiday_notice, ].map{|key| restaurant_line_data[key]} +
    [ restaurant_line_data[:search_words].join("|") ] +
    [:img_count, :has_calendar].map{|key| restaurant_line_data[key]})
end

def process_area(area)
  area_output_name = area.gsub("/", "_")
  FileUtils.mkdir_p("result/restaurants")
  FileUtils.mkdir_p("result/no_subgenre")
  area_restaurant_csv_path = "result/restaurants/restaurants_#{area_output_name}.csv"
  area_no_subgenre_csv_path = "result/no_subgenre/no_subgenre_#{area_output_name}.csv"

  ids = Set.new

  File.open(area_restaurant_csv_path, "w"){|area_restaurant_csv_io|
    process_area_genre(area, nil, GENRE_TREES, proc{|restaurant_lines|
      for restaurant_line in restaurant_lines do
        id = restaurant_line[:id]
        if ids.include?(id) then
          # ignore
        else
          ids.add(id)
          csv_line = restaurant_line_data_to_array(area, restaurant_line).to_csv
          area_restaurant_csv_io.puts csv_line
        end
      end
      area_restaurant_csv_io.flush
    }, proc{|area, genre, last_url, min_rating|
      File.open(area_no_subgenre_csv_path, "a"){|area_no_subgenre_csv_io|
        area_no_subgenre_csv_io.puts([area, genre, last_url, min_rating].to_csv)
      }
    })
  }
end

Parallel.each_with_index(areas, in_threads: MAX_THREADS) do |area, idx|
  puts "[#{Time.now}] #{idx + 1}/#{areas.length} AREA #{area}"
  process_area(area)
end
